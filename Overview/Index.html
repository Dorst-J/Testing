<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Login</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 100px;
      margin: 0;
    }
  </style>
</head>

<body>
  <h2>Sign in with Google to continue</h2>

  <div id="g_id_onload"
       data-client_id="653779522470-ebl157omo84vrsc733eupggldqg1pugk.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"></div>

  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left"></div>

<script>
/** =========================
 *  ROLES (keep these)
 *  ========================= */
const ROLES = {
  ADMIN: "admin",
  OFFICE: "office",
  BOOTH_MANAGER: "booth_manager",
  SELLER: "seller",
};

/** ==========================================
 *  CONFIG (EDIT THIS ONLY — ALL PLACEHOLDERS)
 *  ========================================== */
const CONFIG = {
  // Optional: Worker endpoint for /signin logging (leave "" to disable)
  workerUrl: "",

  // Global pages (not location-based) — fill in later if you want
  globalPages: {
    ADMIN_HOME: "./SimonsAdminDash.html",   // e.g. "./AdminHome.html"
  },

  /**
   * Locations — completely empty placeholders.
   * Add as many as you want like:
   *   "LocationKey": { pages: { main:"...", sell:"...", ... } }
   */
  locations: {
    // Example placeholder (DELETE if you want)
    // "Location1": { pages: { main:"", sell:"", logout:"" } },
  },

  /**
   * Users:
   * - Put allowed emails here
   * - role is required
   * - locations optional (admins/office can be given all by leaving blank)
   * - defaultPage optional (overrides role default)
   */
  users: {
    "sedorst17@gmail.com": { role: ROLES.ADMIN },
    // "seller@gmail.com": { role: ROLES.SELLER, locations: ["Location1"], defaultPage: "" },
  }
};

/** ==========================================
 *  ROLE RULES (what each role can access)
 *  - Edit these arrays if you change your page keys
 *  ========================================== */
const ROLE_RULES = {
  [ROLES.ADMIN]: {
    includeGlobals: ["ADMIN_HOME", "USER_LOG"],
    includeLocationPages: ["main","logout","close","open","sell","shifthandoff","winner"],
    default: () => CONFIG.globalPages.ADMIN_HOME,
  },
  [ROLES.OFFICE]: {
    includeGlobals: ["ADMIN_HOME", "USER_LOG"],
    includeLocationPages: ["main","logout","close","open","sell","shifthandoff","winner"],
    default: () => CONFIG.globalPages.ADMIN_HOME,
  },
  [ROLES.BOOTH_MANAGER]: {
    includeGlobals: [],
    includeLocationPages: ["main","logout","close","open","sell","shifthandoff","winner"],
    default: (locKeys) => {
      const first = locKeys[0];
      return first ? (CONFIG.locations[first]?.pages?.main || "") : "";
    },
  },
  [ROLES.SELLER]: {
    includeGlobals: [],
    includeLocationPages: ["sell","winner","shifthandoff","logout"],
    default: (locKeys) => {
      const first = locKeys[0];
      return first ? (CONFIG.locations[first]?.pages?.sell || "") : "";
    },
  },
};

/** =========================
 *  ACCESS BUILDER
 *  ========================= */
function computeAccess(role, userLocations) {
  const rule = ROLE_RULES[role];
  const pages = new Set();
  if (!rule) return { pages, defaultPage: "" };

  // Globals
  (rule.includeGlobals || []).forEach(k => {
    const p = CONFIG.globalPages[k];
    if (p) pages.add(p);
  });

  // Locations:
  // If userLocations is empty AND role is admin/office -> use ALL configured locations
  const allLocKeys = Object.keys(CONFIG.locations);
  const locKeys = (userLocations && userLocations.length)
    ? userLocations
    : ((role === ROLES.ADMIN || role === ROLES.OFFICE) ? allLocKeys : []);

  // Location pages
  locKeys.forEach(locKey => {
    const loc = CONFIG.locations[locKey];
    if (!loc || !loc.pages) return;
    (rule.includeLocationPages || []).forEach(pageKey => {
      const path = loc.pages[pageKey];
      if (path) pages.add(path);
    });
  });

  const defaultPage = rule.default ? rule.default(locKeys) : "";
  return { pages, defaultPage };
}

/** =========================
 *  SIGN-IN FLOW
 *  ========================= */
let isSignedIn = false;

function handleCredentialResponse(response) {
  const tokenData = parseJwt(response.credential);
  const email = (tokenData.email || "").toLowerCase();
  const name  = tokenData.name || email;

  isSignedIn = true;

  const user = CONFIG.users[email];
  if (!user) {
    alert("You are not authorized to access this site.");
    return;
  }

  const role = user.role;
  const locations = user.locations || [];

  const { pages, defaultPage: roleDefault } = computeAccess(role, locations);
  const redirectPage = user.defaultPage || roleDefault;

  if (!redirectPage) {
    alert("No default page configured for this user/role yet.");
    return;
  }

  // Save access info for other pages to use
  localStorage.setItem("userEmail", email);
  localStorage.setItem("userName", name);
  localStorage.setItem("userRole", role);
  localStorage.setItem("userLocations", JSON.stringify(locations));
  localStorage.setItem("allowedPages", JSON.stringify(Array.from(pages)));

  // Optional sign-in logging
  logSignIn(name, email).finally(() => {
    window.location.href = redirectPage;
  });
}

function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(
    atob(base64).split('').map(c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join('')
  );
  return JSON.parse(jsonPayload);
}

async function logSignIn(name, email) {
  if (!CONFIG.workerUrl) return; // disabled
  try {
    await fetch(`${CONFIG.workerUrl}/signin`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email })
    });
  } catch (err) {
    console.error("Sign-in log failed:", err);
  }
}
</script>

</body>
</html>
