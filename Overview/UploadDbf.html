<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DBF Upload</title>
  <style>
    body { font-family: Arial; margin: 0; }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px; border-bottom:1px solid #ddd; }
    .smallBtn { padding:10px 14px; border-radius:10px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    .wrap { display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:16px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; min-height: 520px; }
    .title { margin:0 0 10px 0; }
    #dropZone {
      border:2px dashed #999; border-radius:12px; padding:28px; text-align:center;
      font-size:18px; color:#444; user-select:none;
    }
    #dropZone.drag { opacity: .7; }
    .list { max-height: 520px; overflow:auto; border:1px solid #eee; border-radius:10px; padding:10px; }
    .item { padding:8px; border-bottom:1px solid #f0f0f0; }
    .meta { color:#666; font-size:13px; }
    .btn { padding:12px 18px; border:none; border-radius:10px; cursor:pointer; }
    .blue { background:#2563eb; color:#fff; }
    .gray { background:#eee; }
    .row { display:flex; gap:10px; align-items:center; }
    input, select { width:100%; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:10px; }

    /* Popup */
    #popup { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); align-items:center; justify-content:center; }
    #popupBox { background:#fff; padding:18px; border-radius:12px; width:min(720px, 92vw); }
    #popupHead { display:flex; justify-content:space-between; align-items:center; }
    #popupX { border:1px solid #bbb; background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; }
    #popupBody { margin-top:10px; }
    #popupActions { margin-top:14px; display:flex; justify-content:flex-end; gap:10px; }
    pre { white-space:pre-wrap; border:1px solid #ddd; padding:10px; border-radius:10px; max-height:240px; overflow:auto; }
  </style>
</head>
<body>

<header>
  <div class="row">
    <button class="smallBtn" onclick="location.href='/Dashboard.html'">Back to Dashboard</button>
    <h2 style="margin:0 0 0 12px;">DBF Upload</h2>
  </div>
  <button class="smallBtn" onclick="location.href='/signout'">Sign out</button>
</header>

<div class="wrap">
  <!-- Left: Live Inventory -->
  <div class="card">
    <h3 class="title">Live Inventory Keys (All Locations)</h3>
    <div class="meta">Newest at top. Updates every 5 seconds.</div>
    <div id="liveList" class="list" style="margin-top:10px;"></div>
  </div>

  <!-- Right: Upload + Emergency -->
  <div class="card">
    <h3 class="title">Upload DBF</h3>
    <div class="meta">Drag & drop a DBF file for a single location. Worker determines location from SITENO last 3 digits.</div>

    <div id="dropZone" style="margin-top:12px;">
      Drag & Drop DBF here<br><br>
      <span class="meta">or click to choose file</span>
      <input id="filePicker" type="file" accept=".dbf" style="display:none;">
    </div>

    <div style="margin-top:14px;">
      <button id="emergencyBtn" class="btn gray">Emergency move</button>
    </div>
  </div>
</div>

<!-- Popup -->
<div id="popup">
  <div id="popupBox">
    <div id="popupHead">
      <h3 id="popupTitle" style="margin:0;">Popup</h3>
      <button id="popupX">X</button>
    </div>
    <div id="popupBody"></div>
    <div id="popupActions">
      <button id="popupCancel" class="smallBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
  // ✅ IMPORTANT: set this to your Worker URL
  const apiBase = "https://overview.jenna-dorst.workers.dev";

  let aborter = null;
  const LOCATIONS = ["Chanticlear","McDuffs","Willies","Northwoods"];

  const popup = document.getElementById("popup");
  const popupTitle = document.getElementById("popupTitle");
  const popupBody = document.getElementById("popupBody");
  const popupCancel = document.getElementById("popupCancel");
  const popupX = document.getElementById("popupX");

  function showPopup(title, bodyHtml, canCancel=true) {
    popupTitle.textContent = title;
    popupBody.innerHTML = bodyHtml;
    popupCancel.style.display = canCancel ? "inline-block" : "none";
    popup.style.display = "flex";
  }
  function hidePopup() { popup.style.display = "none"; }

  popupX.onclick = hidePopup;
  popupCancel.onclick = () => { if (aborter) aborter.abort(); hidePopup(); };
  popup.addEventListener("click", (e)=>{ if(e.target===popup) hidePopup(); });

  async function safeJson(resp) {
    const text = await resp.text();
    let j = null;
    try { j = JSON.parse(text); } catch {}
    return { text, j };
  }

  async function refreshLive() {
    const list = document.getElementById("liveList");
    const r = await fetch(`${apiBase}/api/inventory/live`);
    const { j, text } = await safeJson(r);

    if (!r.ok || !j?.ok) {
      list.innerHTML = `<div class="item"><b>Error loading live list</b><pre>${(j?.error || text || "Unknown error")}</pre></div>`;
      return;
    }

    const items = j.results || [];
    list.innerHTML = items.map(it => `
      <div class="item">
        <div><b>${it.key}</b></div>
        <div class="meta">${it.location}${it.gname ? " — " + it.gname : ""}</div>
      </div>
    `).join("") || `<div class="item">(empty)</div>`;
  }

  // Drag & Drop + click picker
  const dropZone = document.getElementById("dropZone");
  const filePicker = document.getElementById("filePicker");

  dropZone.addEventListener("click", ()=> filePicker.click());

  dropZone.addEventListener("dragover", (e)=>{ e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", ()=> dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", async (e)=>{
    e.preventDefault();
    dropZone.classList.remove("drag");
    const file = e.dataTransfer.files?.[0];
    if (file) await uploadFile(file);
  });

  filePicker.addEventListener("change", async ()=>{
    const file = filePicker.files?.[0];
    filePicker.value = "";
    if (file) await uploadFile(file);
  });

  async function uploadFile(file) {
    aborter = new AbortController();
    showPopup("Uploading games", `<p>Uploading <b>${file.name}</b>…</p>`, true);

    const fd = new FormData();
    fd.append("file", file);

    try {
      const resp = await fetch(`${apiBase}/api/upload-dbf`, {
        method: "POST",
        body: fd,
        signal: aborter.signal
      });

      const { j, text } = await safeJson(resp);
      aborter = null;

      if (!resp.ok || !j?.ok) {
        showPopup("Upload failed", `
          <p>something went wrong, couldn’t upload the game</p>
          <pre>${(j?.error || text || "Unknown error")}</pre>
        `, false);
        return;
      }

      showPopup("Games uploaded", `
        <p>Uploaded <b>${j.inserted}</b> games to <b>${j.location}_Inventory</b>.</p>
      `, false);

      await refreshLive();
    } catch (err) {
      const msg = String(err || "");
      aborter = null;

      if (msg.includes("AbortError")) {
        showPopup("Cancelled", `<p>Upload cancelled.</p>`, false);
      } else {
        showPopup("Upload failed", `<p>${msg}</p>`, false);
      }
    }
  }

  // Emergency Move UI
  document.getElementById("emergencyBtn").onclick = () => {
    showPopup("Emergency move", `
      <p>Enter MFCID_PARTNO_SERNO</p>
      <input id="emKey" placeholder="IG FLMG01 3144629" autocomplete="off">
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button class="smallBtn" id="emCancel">Cancel</button>
        <button class="smallBtn" id="emFind" disabled>Move</button>
      </div>
    `, false);

    const emKey = document.getElementById("emKey");
    const emFind = document.getElementById("emFind");

    function sync() { emFind.disabled = !emKey.value.trim(); }
    emKey.addEventListener("input", sync);
    sync();
    emKey.focus();

    document.getElementById("emCancel").onclick = hidePopup;

    emFind.onclick = async () => {
      const key = emKey.value.trim();

      const resp = await fetch(`${apiBase}/api/emergency/lookup`, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ key })
      });
      const { j, text } = await safeJson(resp);

      if (!resp.ok || !j?.ok) {
        showPopup("Error", `<pre>${(j?.error || text || "Unknown error")}</pre>`, false);
        return;
      }

      if (!j.found) {
        showPopup("Not found", `<p>can’t be found</p>`, false);
        return;
      }

      const fromLoc = j.fromLocation;

      // Step 2: choose destination inventory
      showPopup("Emergency move", `
        <p>Found <b>${key}</b> in <b>${fromLoc}_Inventory</b>.</p>
        <p>Where would you like to move this game?</p>
        <select id="toLoc">
          <option value="">Select inventory table</option>
          ${LOCATIONS.map(l => `<option value="${l}">${l}_Inventory</option>`).join("")}
        </select>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
          <button class="smallBtn" id="emCancel2">Cancel</button>
          <button class="smallBtn" id="emMove" disabled>Move</button>
        </div>
      `, false);

      const toLoc = document.getElementById("toLoc");
      const emMove = document.getElementById("emMove");

      function sync2(){ emMove.disabled = !toLoc.value; }
      toLoc.addEventListener("change", sync2);
      sync2();

      document.getElementById("emCancel2").onclick = hidePopup;

      emMove.onclick = async () => {
        const dest = toLoc.value;

        const resp2 = await fetch(`${apiBase}/api/emergency/move`, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({ key, toLocation: dest })
        });
        const { j: j2, text: t2 } = await safeJson(resp2);

        if (!resp2.ok || !j2?.ok) {
          showPopup("Error", `<pre>${(j2?.error || t2 || "Unknown error")}</pre>`, false);
          return;
        }

        showPopup("Moved", `<p>Moved <b>${key}</b> to <b>${dest}_Inventory</b>.</p>`, false);
        await refreshLive();
      };
    };
  };

  refreshLive();
  setInterval(refreshLive, 5000);
</script>
</body>
</html>
