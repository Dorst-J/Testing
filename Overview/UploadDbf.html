<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DBF Upload</title>
  <style>
    body { font-family: Arial; margin:0; padding:0; }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px; border-bottom:1px solid #ddd; }
    .smallBtn { padding:10px 14px; border-radius:10px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    .layout { display:grid; grid-template-columns: 1fr 1fr; gap:18px; padding:18px; }
    .card { border:1px solid #ddd; border-radius:14px; padding:16px; }
    .drop { border:2px dashed #999; border-radius:14px; padding:34px; text-align:center; cursor:pointer; }
    .muted { color:#666; font-size:14px; }
    .list { margin-top:12px; max-height:520px; overflow:auto; border:1px solid #eee; border-radius:12px; padding:10px; }
    .row { padding:8px; border-bottom:1px solid #f2f2f2; }
    .row:last-child{ border-bottom:none; }
    .pill { display:inline-block; font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; margin-right:8px; }
    .danger { background:#d64545; color:white; border:none; }
    .ok { background:#1f9d55; color:white; border:none; }
    #popup { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); align-items:center; justify-content:center; }
    .modal { background:#fff; padding:18px; border-radius:12px; width:min(720px, 92vw); }
    .modalTop { display:flex; justify-content:space-between; align-items:center; }
    input, select { width:100%; padding:12px; font-size:16px; margin-top:10px; }
    .btnRow { margin-top:14px; display:flex; justify-content:flex-end; gap:10px; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; gap:12px; align-items:center;">
      <button class="smallBtn" onclick="location.href='/Dashboard.html'">Back to Dashboard</button>
      <h2 style="margin:0;">DBF Upload</h2>
    </div>
    <button class="smallBtn" onclick="location.href='/signout'">Sign out</button>
  </header>

  <div class="layout">
    <div class="card">
      <h3 style="margin:0;">Live Inventory Keys (All Locations)</h3>
      <div class="muted" style="margin-top:6px;">Newest at top. Updates every 5 seconds.</div>
      <div id="live" class="list"></div>
    </div>

    <div class="card">
      <h3 style="margin:0;">Upload DBF</h3>
      <div class="muted" style="margin-top:6px;">
        Drag & drop a DBF file for a single location. Worker determines location from SITENO last 3 digits.
      </div>

      <div id="drop" class="drop" style="margin-top:14px;">
        <div style="font-size:20px;">Drag & Drop DBF here</div>
        <div class="muted" style="margin-top:8px;">or click to choose file</div>
      </div>
      <input id="filePick" type="file" accept=".dbf" style="display:none;">

      <div style="margin-top:14px;">
        <button class="smallBtn danger" id="emergencyBtn">Emergency move</button>
      </div>
    </div>
  </div>

  <div id="popup">
    <div class="modal">
      <div class="modalTop">
        <h3 id="pTitle" style="margin:0;">Uploading</h3>
        <button id="pX" class="smallBtn">X</button>
      </div>
      <div id="pBody" style="margin-top:10px;"></div>
      <div class="btnRow">
        <button id="pCancel" class="smallBtn">Cancel</button>
      </div>
    </div>
  </div>

<script>
const apiBase = "https://overview.jenna-dorst.workers.dev";

async function api(path, options = {}) {
  const resp = await fetch(`${apiBase}${path}`, options);
  const txt = await resp.text();
  try { return JSON.parse(txt); } catch { return { ok:false, error: txt || `HTTP ${resp.status}` }; }
}

const liveEl = document.getElementById("live");
const drop = document.getElementById("drop");
const filePick = document.getElementById("filePick");

let aborter = null;

function showPopup(title, bodyHtml, canCancel=true){
  document.getElementById("pTitle").textContent = title;
  document.getElementById("pBody").innerHTML = bodyHtml;
  document.getElementById("pCancel").style.display = canCancel ? "inline-block" : "none";
  document.getElementById("popup").style.display = "flex";
}
function hidePopup(){ document.getElementById("popup").style.display="none"; }

document.getElementById("pX").onclick = hidePopup;
document.getElementById("pCancel").onclick = () => {
  if (aborter) aborter.abort();
  hidePopup();
};

async function refreshLive(){
  const r = await api("/api/inventory/live");
  if (!r.ok) {
    liveEl.innerHTML = `<div class="row"><b>Error:</b> ${r.error}</div>`;
    return;
  }
  const items = r.results || [];
  if (items.length === 0) {
    liveEl.innerHTML = `<div class="row">(empty)</div>`;
    return;
  }
  liveEl.innerHTML = items.map(x => `
    <div class="row">
      <span class="pill">${x.location}</span>
      <b>${x.key}</b>
      <div class="muted">${x.gname || ""}</div>
    </div>
  `).join("");
}

function wireFile(file){
  if (!file) return;
  doUpload(file);
}

drop.addEventListener("click", ()=> filePick.click());
filePick.addEventListener("change", ()=> wireFile(filePick.files?.[0]));

drop.addEventListener("dragover", e => { e.preventDefault(); drop.style.opacity=.7; });
drop.addEventListener("dragleave", () => drop.style.opacity=1);
drop.addEventListener("drop", (e) => {
  e.preventDefault();
  drop.style.opacity=1;
  const file = e.dataTransfer.files?.[0];
  wireFile(file);
});

async function doUpload(file){
  aborter = new AbortController();
  showPopup("Uploading games", "<p>Uploading games…</p>", true);

  const fd = new FormData();
  fd.append("file", file);

  try {
    const resp = await fetch(`${apiBase}/api/upload-dbf`, { method:"POST", body: fd, signal: aborter.signal });
    const txt = await resp.text();
    let j; try { j = JSON.parse(txt); } catch { j = { ok:false, error: txt }; }

    aborter = null;

    if (!j.ok) {
      showPopup("Upload failed", `<p>something went wrong, couldn’t upload the game</p><pre>${j.error||""}</pre>`, false);
      return;
    }

    showPopup("Done", `<p>Games have been uploaded (${j.inserted}) to ${j.location}_Inventory</p>`, false);
    await refreshLive();
  } catch (err) {
    aborter = null;
    if (String(err).includes("AbortError")) {
      showPopup("Cancelled", "<p>Upload cancelled.</p>", false);
    } else {
      showPopup("Upload failed", `<p>something went wrong, couldn’t upload the game</p><pre>${String(err)}</pre>`, false);
    }
  }
}

/* Emergency move */
document.getElementById("emergencyBtn").onclick = () => {
  showPopup("Emergency move", `
    <div class="muted">Enter a MFCID_PARTNO_SERNO to search ALL inventory tables.</div>
    <input id="eKey" placeholder="IG FLMG01 3144629">
    <div class="btnRow">
      <button class="smallBtn" id="eCancel">Cancel</button>
      <button class="smallBtn ok" id="eGo" disabled>Move</button>
    </div>
  `, false);

  const eKey = document.getElementById("eKey");
  const eGo = document.getElementById("eGo");

  function sync(){
    const ok = eKey.value.trim();
    eGo.disabled = !ok;
  }
  eKey.addEventListener("input", sync);
  sync();

  document.getElementById("eCancel").onclick = hidePopup;

  eGo.onclick = async () => {
    const key = eKey.value.trim();
    const r = await api("/api/emergency/lookup", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ key })
    });

    if (!r.ok) return showPopup("Error", `<pre>${r.error}</pre>`, false);
    if (!r.found) return showPopup("Not found", `<p>can’t be found</p>`, false);

    showPopup("Emergency move", `
      <p>Found <b>${key}</b> in <b>${r.fromLocation}_Inventory</b></p>
      <div class="muted">Where would you like to move this game?</div>
      <select id="toLoc">
        <option value="">Select inventory table…</option>
        <option>Chanticlear</option>
        <option>McDuffs</option>
        <option>Willies</option>
        <option>Northwoods</option>
      </select>
      <div class="btnRow">
        <button class="smallBtn" id="c2">Cancel</button>
        <button class="smallBtn ok" id="m2" disabled>Move</button>
      </div>
    `, false);

    const toLoc = document.getElementById("toLoc");
    const m2 = document.getElementById("m2");

    toLoc.addEventListener("change", ()=> {
      m2.disabled = !toLoc.value;
    });

    document.getElementById("c2").onclick = hidePopup;

    m2.onclick = async () => {
      const toLocation = toLoc.value;
      const r2 = await api("/api/emergency/move", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ key, toLocation })
      });
      if (!r2.ok) return showPopup("Error", `<pre>${r2.error}</pre>`, false);
      hidePopup();
      await refreshLive();
    };
  };
};

refreshLive();
setInterval(refreshLive, 5000);
</script>
</body>
</html>
