<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Deposit</title>
  <style>
    body{font-family:Arial;margin:0}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #ddd}
    .btn{padding:12px 18px;border:none;border-radius:10px;cursor:pointer}
    .blue{background:#2563eb;color:#fff}
    .green{background:#16a34a;color:#fff}
    .smallBtn{padding:8px 12px;border-radius:10px;border:1px solid #bbb;background:#fff;cursor:pointer}
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}
    .modal{background:#fff;width:min(720px,92vw);border-radius:14px;padding:18px}
    .dangerX{position:absolute;right:18px;top:14px;background:#d64545;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    .modalHeader{position:relative;padding-right:60px}

    /* 3-column layout */
    .listWrap{padding:0 16px 16px 16px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px}
    .row{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #eee}
    .row:last-child{border-bottom:none}
    .muted{color:#666;font-size:13px}
    .colHeader{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .title{font-weight:700}
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0">Deposit</h2>
    <button class="smallBtn" onclick="location.href='/Dashboard.html'">Back to Dashboard</button>
  </header>

  <div style="padding:16px;display:flex;gap:12px">
    <button id="toBank" class="btn blue">ToBank</button>
    <button id="atBank" class="btn green">AtBank</button>
  </div>

  <div style="padding:0 16px 16px 16px">
    <button class="smallBtn" onclick="location.href='/Dashboard.html'">Back</button>
  </div>

  <!-- 3 columns -->
  <div class="listWrap">
    <div class="colHeader" style="margin-bottom:10px;">
      <div>
        <div class="title">Deposit</div>
        <div class="muted" id="status">(loading...)</div>
      </div>
      <button class="smallBtn" id="refreshBtn">Refresh</button>
    </div>

    <div class="grid3">
      <div class="card">
        <div class="title">At the Office</div>
        <div class="muted" style="margin-top:6px;">Not taken to bank yet</div>
        <div id="colOffice" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="title">Going to Bank</div>
        <div class="muted" style="margin-top:6px;">ToBank completed</div>
        <div id="colGoing" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="title">AT Bank</div>
        <div class="muted" style="margin-top:6px;">AtBank completed</div>
        <div id="colBank" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <div id="backdrop" class="modalBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="modalTitle" style="margin:0">Modal</h3>
        <button id="modalX" class="dangerX">X</button>
      </div>
      <div id="modalBody" style="margin-top:10px"></div>
    </div>
  </div>

<script>
const apiBase = "https://overview.jenna-dorst.workers.dev";

async function api(path, options = {}) {
  const resp = await fetch(`${apiBase}${path}`, {
    ...options,
    headers: { "content-type":"application/json", ...(options.headers||{}) }
  });
  const txt = await resp.text();
  try { return JSON.parse(txt); }
  catch { return { ok:false, error: txt || `HTTP ${resp.status}` }; }
}

const backdrop = document.getElementById("backdrop");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
document.getElementById("modalX").onclick = ()=> backdrop.style.display="none";
backdrop.addEventListener("click", e=>{ if(e.target===backdrop) backdrop.style.display="none"; });
function openModal(title, html){ modalTitle.textContent=title; modalBody.innerHTML=html; backdrop.style.display="flex"; }

function setStatus(msg){ document.getElementById("status").textContent = msg || ""; }

function renderColumn(hostId, rows){
  const host = document.getElementById(hostId);
  if(!rows || rows.length === 0){
    host.innerHTML = `<div class="muted">(none)</div>`;
    return;
  }

  host.innerHTML = rows.map(r => {
    const key = r.MFCID_PARTNO_SERNO || "";
    const cash = Number(r.CASH_HAND || 0).toFixed(2);
    const pickup = r.PICK_UP || "";
    const going = r.GOING_TO_BANK ? `GoingToBank: ${r.GOING_TO_BANK}` : "GoingToBank: (not yet)";
    const dropped = r.DROPED_AT_BANK ? `AtBank: ${r.DROPED_AT_BANK}` : "AtBank: (not yet)";
    return `
      <div class="row">
        <div>
          <div style="font-weight:700">${key}</div>
          <div class="muted">$${cash} — ${pickup}</div>
          <div class="muted">${going}</div>
          <div class="muted">${dropped}</div>
        </div>
      </div>
    `;
  }).join("");
}

async function loadList(){
  setStatus("Loading...");
  const r = await api("/api/deposit/list", { method:"GET", headers:{} });
  if(!r.ok){
    setStatus(`Error: ${r.error || "Failed to load"}`);
    document.getElementById("colOffice").innerHTML = `<div class="muted">(error)</div>`;
    document.getElementById("colGoing").innerHTML = `<div class="muted">(error)</div>`;
    document.getElementById("colBank").innerHTML = `<div class="muted">(error)</div>`;
    return;
  }

  const rows = r.results || [];

  const atOffice = rows.filter(x => !x.GOING_TO_BANK && !x.DROPED_AT_BANK);
  const goingToBank = rows.filter(x => !!x.GOING_TO_BANK && !x.DROPED_AT_BANK);
  const atBank = rows.filter(x => !!x.DROPED_AT_BANK);

  renderColumn("colOffice", atOffice);
  renderColumn("colGoing", goingToBank);
  renderColumn("colBank", atBank);

  setStatus(`Loaded ${rows.length} total — Office ${atOffice.length}, Going ${goingToBank.length}, Bank ${atBank.length}`);
}

document.getElementById("refreshBtn").onclick = loadList;

document.getElementById("toBank").onclick = async () => {
  const r = await api("/api/deposit/list", { method:"GET", headers:{} });
  if(!r.ok) return openModal("Error", `<p>${r.error||"Error"}</p>`);

  const pending = (r.results || []).filter(x => !x.GOING_TO_BANK && !x.DROPED_AT_BANK);

  const list = pending.map(d=>`
    <label style="display:flex;gap:10px;align-items:center;margin:8px 0;">
      <input type="checkbox" class="k" value="${d.MFCID_PARTNO_SERNO}">
      <span>${d.MFCID_PARTNO_SERNO} — $${Number(d.CASH_HAND||0).toFixed(2)} — ${d.PICK_UP||""}</span>
    </label>
  `).join("") || "<p>(none)</p>";

  openModal("Taking to bank", `
    <div style="max-height:320px;overflow:auto;border:1px solid #ddd;border-radius:10px;padding:10px;">${list}</div>
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
      <button class="smallBtn" id="cancel">cancel</button>
      <button class="smallBtn" id="go">taking to bank</button>
    </div>
  `);
  document.getElementById("cancel").onclick = ()=> backdrop.style.display="none";
  document.getElementById("go").onclick = async () => {
    const keys = [...document.querySelectorAll(".k:checked")].map(x=>x.value);
    if(keys.length===0) return;

    const r2 = await api("/api/deposit/toBank", {
      method:"POST",
      body: JSON.stringify({ keys })
    });
    if(!r2.ok) return openModal("Error", `<p>${r2.error||"Error"}</p>`);
    backdrop.style.display="none";
    loadList();
  };
};

document.getElementById("atBank").onclick = async () => {
  const r = await api("/api/deposit/list", { method:"GET", headers:{} });
  if(!r.ok) return openModal("Error", `<p>${r.error||"Error"}</p>`);

  const ready = (r.results || []).filter(x => !!x.GOING_TO_BANK && !x.DROPED_AT_BANK);

  const list = ready.map(d=>`
    <label style="display:flex;gap:10px;align-items:center;margin:8px 0;">
      <input type="checkbox" class="k2" value="${d.MFCID_PARTNO_SERNO}">
      <span>${d.MFCID_PARTNO_SERNO} — $${Number(d.CASH_HAND||0).toFixed(2)} — ${d.PICK_UP||""}</span>
    </label>
  `).join("") || "<p>(none)</p>";

  openModal("Dropped at bank", `
    <div style="max-height:320px;overflow:auto;border:1px solid #ddd;border-radius:10px;padding:10px;">${list}</div>
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
      <button class="smallBtn" id="cancel2">cancel</button>
      <button class="smallBtn" id="go2">AtBank</button>
    </div>
  `);
  document.getElementById("cancel2").onclick = ()=> backdrop.style.display="none";
  document.getElementById("go2").onclick = async () => {
    const keys = [...document.querySelectorAll(".k2:checked")].map(x=>x.value);
    if(keys.length===0) return;

    const r2 = await api("/api/deposit/atBank", {
      method:"POST",
      body: JSON.stringify({ keys })
    });
    if(!r2.ok) return openModal("Error", `<p>${r2.error||"Error"}</p>`);
    backdrop.style.display="none";
    loadList();
  };
};

loadList();
setInterval(loadList, 8000);
</script>
</body>
</html>
