<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta charset="UTF-8" />
<title>Pull Tab Ticket Calculator</title>
<style>
  body {
    font-family: sans-serif;
    background: #f0f0f0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .calculator {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 360px;
  }
  h2 { text-align: center; margin-bottom: 20px; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input {
    width: 100%; padding: 8px; margin-top: 5px;
    font-size: 1.2em; text-align: right;
  }
  .button-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
  button {
    padding: 10px; font-size: 1.1em; border: none;
    border-radius: 5px; cursor: pointer;
  }
  .calculate-btn { background-color: #007bff; color: white; }
  .clear-btn { background-color: #ffc107; }
  .return-btn { background-color: #dc3545; color: white; }
  .results {
    margin-top: 20px; font-size: 1.2em; text-align: center;
    padding: 10px; border: 1px solid #ccc; border-radius: 5px;
  }
  .numpad {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 10px; margin-top: 15px;
  }
  .numpad button { font-size: 1.2em; background-color: #e0e0e0; }
  .numpad .backspace { background-color: #ff8888; }
</style>
</head>
<body>

<div class="calculator">
  <h2>Pull Tab Ticket Calculator</h2>

  <label for="moneyInput">Money Inserted ($):</label>
  <input type="text" id="moneyInput" readonly onclick="setActiveInput('moneyInput')" placeholder="0.00">

  <label for="ticketPrice">Price per Ticket ($):</label>
  <input type="text" id="ticketPrice" readonly placeholder="0.00">

  <div class="numpad">
    <button onclick="press('7')">7</button><button onclick="press('8')">8</button><button onclick="press('9')">9</button>
    <button onclick="press('4')">4</button><button onclick="press('5')">5</button><button onclick="press('6')">6</button>
    <button onclick="press('1')">1</button><button onclick="press('2')">2</button><button onclick="press('3')">3</button>
    <button onclick="press('0')">0</button><button onclick="press('.')">.</button>
    <button class="backspace" onclick="backspace()">←</button>
  </div>

  <div class="button-group">
    <button class="calculate-btn" onclick="calculateTickets()">Calculate Tickets</button>
    <button class="clear-btn" onclick="clearFields()">Clear</button>
    <button class="return-btn" onclick="goToMainPage()">Return</button>
  </div>

  <div class="results" id="results" style="display:none;">
    <strong>Tickets to Give:</strong> <span id="ticketCount"></span>
  </div>
</div>

<script>
const WORKER_URL = "https://thedatatab.jenna-dorst.workers.dev";
let activeInputId = "moneyInput";
let currentBoxNumber = null;
let rolledMoney = 0;
let rolloverActive = false;

window.onload = async function() {
  const moneyInput = document.getElementById('moneyInput');
  currentBoxNumber = sessionStorage.getItem('currentBoxNumber');

  if (!currentBoxNumber) {
    alert("No box selected. Returning to main page.");
    goToMainPage();
    return;
  }

  rolledMoney = parseFloat(sessionStorage.getItem('rolledMoney') || "0");
  rolloverActive = rolledMoney > 0;
  if (rolloverActive) {
    console.log(`Rollover pending: $${rolledMoney.toFixed(2)}`);
    moneyInput.value = rolledMoney.toFixed(2);
  }

  try {
    const res = await fetch(WORKER_URL + '/api/open/games');
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    const game = data.games.find(g => g.Box_Number == currentBoxNumber);
    if (game) document.getElementById('ticketPrice').value = parseFloat(game.Ticket_Price).toFixed(2);
  } catch (err) {
    alert("Error loading game info: " + err.message);
    goToMainPage();
  }
};

function setActiveInput(id) {
  activeInputId = id;
  document.querySelectorAll("input").forEach(el => el.style.border = "1px solid #ccc");
  document.getElementById(id).style.border = "2px solid blue";
}

function press(val) {
  const input = document.getElementById(activeInputId);
  if (!input || activeInputId === 'ticketPrice') return;
  if (val === '.' && input.value.includes('.')) return;
  input.value += val;
}

function backspace() {
  const input = document.getElementById(activeInputId);
  if (input && activeInputId !== 'ticketPrice') input.value = input.value.slice(0, -1);
}

function clearFields() {
  document.getElementById('moneyInput').value = '';
  document.getElementById('results').style.display = 'none';
  sessionStorage.setItem('rolledMoney', "0");
  rolloverActive = false;
  rolledMoney = 0;
  console.log("Cleared sale inputs and reset rollover.");
}

function goToMainPage() {
  sessionStorage.removeItem('currentBoxNumber');
  window.location.href = "./Chanticlear.html";
}

async function calculateTickets() {
  const money = parseFloat(document.getElementById('moneyInput').value);
  const price = parseFloat(document.getElementById('ticketPrice').value);
  if (isNaN(money) || isNaN(price) || price <= 0) {
    alert("Please enter valid money and price.");
    return;
  }

  const calculatedTickets = Math.floor(money / price);
  document.getElementById('ticketCount').textContent = calculatedTickets;
  document.getElementById('results').style.display = 'block';

  const boxNumber = parseInt(sessionStorage.getItem('currentBoxNumber'));
  if (!boxNumber) return alert("Missing box number.");

  let adjustedMoney = money;
  if (rolloverActive && rolledMoney > 0) {
    adjustedMoney = money - rolledMoney;
    rolloverActive = false;
    sessionStorage.setItem('rolledMoney', "0");
  }

  let endpoint = '/api/game/sell';
  let payload = { boxNumber, moneyInserted: adjustedMoney, ticketsSold: calculatedTickets };

  // If rollover sale, skip cash adjustment but still update ticket counts
  if (adjustedMoney <= 0) {
    endpoint = '/api/game/sell/rollover';
    payload = { boxNumber, ticketsSold: calculatedTickets };
  }

  try {
    const res = await fetch(WORKER_URL + endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await res.json();

    if (result.success) {
      if (endpoint.includes("rollover")) {
        alert(`Rollover sale recorded — ${calculatedTickets} tickets sold.`);
      } else {
        console.log("Sale recorded successfully.");
      }
    } else {
      alert(`Sale failed: ${result.error}`);
    }
  } catch (err) {
    alert(`Error communicating with server: ${err.message}`);
  }
}
</script>
</body>
</html>
